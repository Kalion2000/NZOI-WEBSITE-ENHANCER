// ==UserScript==
// @name        NZOI Dashboard Upgrade
// @namespace   http://tampermonkey.net/
// @version     2.0
// @description Enhanced NZOI Dashboard with a modern UI
// @match       https://train.nzoi.org.nz/*
// @grant       GM_addStyle
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_deleteValue
// @require     https://code.jquery.com/jquery-3.6.0.min.js
// ==/UserScript==
(async()=>{"use strict";const n=location.href,t="https://train.nzoi.org.nz/"===n;if(/^https:\/\/train\.nzoi\.org\.nz\/problems\//.test(n))return;if(!t)return void GM_addStyle("\n      body, html {\n        background-color: #1e1e1e !important;\n        color: #ddd !important;\n      }\n\n      a { color: #88caff !important; }\n      table, td, th {\n        background-color: #2a2a2a !important;\n        color: #e0e0e0 !important;\n        border-color: #444 !important;\n      }\n      input, select, textarea {\n        background-color: #2c2c2c !important;\n        color: #fff !important;\n        border: 1px solid #444 !important;\n      }\n    ");if(!window.puter){const n=document.createElement("script");n.src="https://js.puter.com/v2/",document.head.appendChild(n),await new Promise(t=>n.onload=t)}const a=window.jQuery,o=[800,1200,1400,1600,1900,2100,2400,9999],r=["gray","green","cyan","blue","violet","orange","red","legendary"];let e=!1,i="rating",p=[];const s=new Set,l=new Set,c=[];const d=()=>{const n=a("#search").val().toLowerCase(),t=a("#tag-filter").val(),o=a("#diff-filter").val(),r=a("#group-filter").val(),l=p.filter(a=>{const e=(a.name+" "+a.tags.join(" ")+" "+a.rating).toLowerCase();return!(n&&!e.includes(n))&&("All Tags"===t||a.tags.map(n=>n.toLowerCase()).includes(t.toLowerCase()))&&("All Groups"===r||a.group.toLowerCase()===r.toLowerCase())&&!("800-1200"===o&&a.rating>1200)&&("1201-1600"!==o||!(a.rating<=1200||a.rating>1600))&&!("1601+"===o&&a.rating<=1600)});l.sort((n,t)=>{let a;switch(i){case"name":a=n.name.localeCompare(t.name);break;case"group":a=n.group.localeCompare(t.group);break;case"tag":a=n.tags.join(", ").localeCompare(t.tags.join(", "));break;case"rating":a=n.rating-t.rating;break;case"progress":a=n.progress-t.progress;break;default:a=0}return a*(e?1:-1)}),s.clear(),l.forEach(n=>n.tags.forEach(n=>s.add(n))),m(l)},m=n=>{const t=a("#cf-table tbody");t.empty(),0!==n.length?n.forEach(n=>{const e=a("<tr></tr>"),i=100===n.progress?"rgb(0,200,0)":n.progress>60?"rgb(100,200,100)":n.progress>30?"rgb(200,180,0)":"rgb(200,100,100)",p=r.find((t,a)=>n.rating<=o[a]);e.append(`<td><a href='${n.href}' style='color:#007bff;font-weight:500;'>${n.name}</a></td>`),e.append(`\n                <td>\n                    <div class="progress-container">\n                        <div class="progress-bar">\n                            <div class="progress-fill" style="width:${n.progress}%; background:${i}"></div>\n                        </div>\n                        <span>${n.progress}%</span>\n                    </div>\n                </td>\n            `),e.append(`<td>${n.group}</td>`),e.append(`<td>${n.tags.join(", ")}</td>`),e.append(`<td data-raw='${n.rating}'><span class='${p}' style='font-weight:700;'>${n.rating}</span></td>`),t.append(e)}):t.html('<tr><td colspan="5" style="text-align:center; padding: 20px;">No problems found</td></tr>')},g=()=>{const n=[];return a(".subheading").each(function(){const t=a(this).find("td:first").text().trim(),o=a(this).find("td:first").attr("onclick")?.match(/'([^']+)'/)?.[1];o&&a(`#${o} table tbody tr`).each(function(){const o=a(this).find("td").first().find('a[href^="/problems/"]');if(!o.length)return;const r=o.attr("href"),e=o.text().trim(),i=a(this).find("td").eq(1).text().trim();let p=0;if(i.includes("%"))p=parseInt(i);else if(i.includes("/")){const[n,t]=i.split("/").map(Number);!isNaN(n)&&!isNaN(t)&&t>0&&(p=Math.round(n/t*100))}n.push({id:r.split("/").pop(),name:e,href:r,group:t,progress:p})})}),n},h=setInterval(()=>{if(a('h2:contains("Public Problems")').length||a(".main_table").length){clearInterval(h),"v3"!==GM_getValue("cache_version")&&(GM_setValue("cache_version","v3"),Object.keys(localStorage).filter(n=>n.startsWith("nztags_")).forEach(n=>localStorage.removeItem(n))),async function(n){const t=a("#side").clone();a("#main-container").html(t).append(`\n            <div style="flex: 1; max-width: calc(100% - 260px);">\n                <div class="header-container">\n                    <h2 style='color:white; margin:0;'>All Problems</h2>\n                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">\n                        <div class="stats-badge">\n                            <span id="cached-count">0</span>/${n.length} problems classified\n                        </div>\n                        <div class="cache-controls">\n                            <button id="refresh-cache" class="cache-btn">Refresh AI Classifications</button>\n                            <button id="clear-cache" class="cache-btn">Clear All Cache</button>\n                        </div>\n                    </div>\n                </div>\n                <div class="controls-container">\n                    <div class="filters-container">\n                        <input id='search' placeholder='Search problems...' style='flex:1;min-width:200px;'>\n                        <select id='tag-filter'><option>All Tags</option></select>\n                        <select id='diff-filter'>\n                            <option>All Difficulties</option>\n                            <option>800-1200</option>\n                            <option>1201-1600</option>\n                            <option>1601+</option>\n                        </select>\n                        <select id='group-filter'><option>All Groups</option></select>\n                    </div>\n                </div>\n                <div style="overflow-x:auto;">\n                    <table id='cf-table' class='main_table'>\n                        <thead>\n                            <tr>\n                                <th id='name-header'>Name</th>\n                                <th id='progress-header'>Progress</th>\n                                <th id='group-header'>Group</th>\n                                <th id='tag-header'>Tags</th>\n                                <th id='rating-header'>Rating</th>\n                            </tr>\n                        </thead>\n                        <tbody><tr><td colspan="5">Loading problems...</td></tr>\n                    </table>\n                </div>\n            </div>\n            <div style="width: 240px; margin-top: 30px;">\n                <h2 style="padding-bottom: 10px; border-bottom: 1px solid #333; margin-top: 0; color: #eee;">My Groups</h2>\n                <div style="margin-top: 3px; border-bottom: 1px solid #333; text-align: right;">\n                    <div style="float: left; color: #9cf;"><b><a href="/groups/124">NZIC 2025</a></b></div>\n                    <i>&nbsp;</i>\n                </div>\n            </div>\n        `),a("#refresh-cache").click(()=>{p.forEach(n=>localStorage.removeItem(`nztags_${n.id}`)),location.reload()}),a("#clear-cache").click(()=>{Object.keys(localStorage).filter(n=>n.startsWith("nztags_")).forEach(n=>localStorage.removeItem(n)),location.reload()}),n.forEach(n=>l.add(n.group)),l.forEach(n=>a("#group-filter").append(new Option(n,n)));const o=a("#tag-filter").empty().append("<option>All Tags</option>");n.forEach(n=>{const t=localStorage.getItem(`nztags_${n.id}`);if(t)try{JSON.parse(t).tags.forEach(n=>s.add(n))}catch{}}),Array.from(s).sort().forEach(n=>o.append(new Option(n,n)));const r=[];n.forEach(n=>{const t=localStorage.getItem(`nztags_${n.id}`);if(t)try{c.push({...n,...JSON.parse(t)})}catch{r.push(n)}else r.push(n)}),a("#cached-count").text(c.length),p=c,d(),r.length>0&&await async function(n){for(let t=0;t<n.length;t++){const r=n[t],e=`nztags_${r.id}`,i=await o(r);localStorage.setItem(e,JSON.stringify(i)),p.push({...r,...i}),t%3!=0&&t!==n.length-1||(d(),a("#cached-count").text(p.length)),await new Promise(n=>setTimeout(n,500))}}(r,n.length)}(g()),a("#search, #tag-filter, #diff-filter, #group-filter").on("input change",d);const n=(n,t)=>{a(`#${n}`).click(()=>{i===t?e=!e:(i=t,e=!0),d()})};n("name-header","name"),n("progress-header","progress"),n("group-header","group"),n("tag-header","tag"),n("rating-header","rating"),d()}},300);GM_addStyle("\n        body, html, #main-container, #main-page-title-box {\n            background-color: #121212 !important;\n            color: #e0e0e0 !important;\n            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            line-height: 1.6;\n            margin: 0;\n            padding: 0;\n        }\n\n        /* --- Main Layout and Containers --- */\n        #main-container {\n            padding: 30px;\n            display: flex;\n            gap: 30px;\n            align-items: flex-start;\n        }\n\n        .header-container {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding-bottom: 20px;\n            border-bottom: 1px solid #333;\n            margin-bottom: 20px;\n        }\n\n        .header-container h2 {\n            color: #ffffff;\n            font-size: 2.2em;\n            font-weight: 700;\n            margin: 0;\n        }\n\n        .controls-container {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 15px;\n            margin-bottom: 25px;\n            align-items: center;\n        }\n\n        .filters-container {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 10px;\n            flex-grow: 1;\n        }\n\n        /* --- Form Elements: Input, Select, Buttons --- */\n        #main-container input, #main-container select, .cache-btn {\n            background-color: #2a2a2a !important;\n            color: #e0e0e0 !important;\n            border: 1px solid #444 !important;\n            border-radius: 6px !important;\n            padding: 10px 14px !important;\n            font-size: 14px !important;\n            font-family: inherit !important;\n            transition: all 0.2s ease-in-out !important;\n            outline: none !important;\n            -webkit-appearance: none !important;\n            -moz-appearance: none !important;\n            appearance: none !important;\n        }\n\n        #main-container input::placeholder {\n            color: #888 !important;\n        }\n\n        #main-container input:focus, #main-container select:focus {\n            border-color: #007bff !important;\n            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;\n            background-color: #3a3a3a !important;\n        }\n\n        .cache-btn {\n            cursor: pointer !important;\n            font-weight: 600 !important;\n            min-width: 150px !important;\n            text-align: center !important;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;\n        }\n\n        .cache-btn:hover {\n            transform: translateY(-2px) !important;\n            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;\n        }\n\n        .cache-btn:active {\n            transform: translateY(0) !important;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;\n        }\n\n        #refresh-cache {\n            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;\n            border: none !important;\n            color: #fff !important;\n        }\n\n        #clear-cache {\n            background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%) !important;\n            border: none !important;\n            color: #fff !important;\n        }\n\n        #search {\n            flex: 1 1 200px !important;\n        }\n\n        /* --- Table Styles --- */\n        #cf-table.main_table {\n            background: #1e1e1e !important;\n            color: #e0e0e0 !important;\n            border-collapse: separate !important;\n            border-spacing: 0 !important;\n            width: 100% !important;\n            border: 1px solid #333 !important;\n            border-radius: 12px !important;\n            overflow: hidden !important;\n            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3) !important;\n        }\n\n        #cf-table.main_table th {\n            background: #1a1a1a !important;\n            color: #c0c0c0 !important;\n            padding: 15px 20px !important;\n            text-align: left !important;\n            font-weight: 600 !important;\n            text-transform: uppercase !important;\n            font-size: 0.9em !important;\n            letter-spacing: 0.5px !important;\n            user-select: none !important;\n            border-bottom: 2px solid #333 !important;\n            cursor: pointer !important;\n            transition: background-color 0.2s !important;\n        }\n\n        #cf-table.main_table th:hover {\n            background: #252525 !important;\n        }\n\n        #cf-table.main_table td {\n            border-bottom: 1px solid #333 !important;\n            padding: 15px 20px !important;\n            background: #1e1e1e !important;\n            color: #e0e0e0 !important;\n        }\n\n        #cf-table.main_table tr:hover {\n            background: #252525 !important;\n            transition: background-color 0.2s !important;\n        }\n\n        #cf-table.main_table tr:last-child td {\n            border-bottom: none !important;\n        }\n\n        /* --- Typography and Colors --- */\n        a {\n            color: #007bff !important;\n            text-decoration: none !important;\n            transition: color 0.2s !important;\n        }\n\n        a:hover {\n            color: #66aaff !important;\n            text-decoration: underline !important;\n        }\n\n        .gray { color: #888 !important; }\n        .green { color: #4CAF50 !important; }\n        .cyan { color: #00BCD4 !important; }\n        .blue { color: #2196F3 !important; }\n        .violet { color: #9c27b0 !important; }\n        .orange { color: #ff9800 !important; }\n        .red { color: #f44336 !important; font-weight: 700 !important; }\n        .legendary { color: #FFD700 !important; font-weight: 700 !important; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5) !important; }\n\n        .stats-badge {\n            background: #2a2a2a !important;\n            border: 1px solid #444 !important;\n            color: #e0e0e0 !important;\n            padding: 6px 12px !important;\n            border-radius: 20px !important;\n            font-size: 0.9em !important;\n            font-weight: 500 !important;\n        }\n\n        .stats-badge #cached-count {\n            color: #007bff !important;\n            font-weight: 700 !important;\n        }\n\n        /* --- Progress Bar --- */\n        .progress-container {\n            display: flex !important;\n            align-items: center !important;\n            gap: 10px !important;\n        }\n\n        .progress-bar {\n            width: 80px !important;\n            height: 8px !important;\n            background: #333 !important;\n            border-radius: 4px !important;\n            overflow: hidden !important;\n            position: relative !important;\n        }\n\n        .progress-fill {\n            height: 100% !important;\n            border-radius: 4px !important;\n            transition: width 0.4s ease-in-out !important;\n        }\n\n        /* --- Responsive Adjustments --- */\n        @media (max-width: 1024px) {\n            #main-container {\n                flex-direction: column !important;\n                gap: 20px !important;\n                padding: 20px !important;\n            }\n        }\n    ")})();
