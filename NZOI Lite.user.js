// ==UserScript==
// @name         NZOI Lite
// @namespace    http://tampermonkey.net/
// @version      1.0
// @match        https://train.nzoi.org.nz/problems/*
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-end
// ==/UserScript==
!function(){"use strict";let e=localStorage.getItem("nzoi-theme")||"dark";document.documentElement.setAttribute("data-theme",e);let t,n=(window.location.pathname.match(/\/problems\/([^\/]+)/)||[])[1]||"default",o=[];async function r(e){let t={language:"c++",version:"10.2.0",filename:"main.cpp"},n=e.getValue(),r=document.getElementById("results-summary"),a=document.getElementById("results-details");r.innerHTML="<Lite NZOI Editor - Running tests...</div>",a.innerHTML="";let s=0,l=0;for(let e of o){l++,r.innerHTML=`<div class="loading">Running test ${l}/${o.length}...</div>`;try{let o=await d(n,t,e.input.trim()),r=o.output.trim()===e.output.trim()&&"Accepted"===o.status;r||"Accepted"!==o.status||(o.status="Wrong Answer"),r&&s++,i({id:e.id,status:o.status,output:o.output,expected:e.output,time:o.time,match:r},a)}catch(t){i({id:e.id,status:"Error",output:String(t),expected:e.output,match:!1},a)}}r.innerHTML=`<div class="summary ${s===o.length?"passed":"failed"}">\n        ${s}/${o.length} Passed\n      </div>`}function i(e,t){let n=document.createElement("div");n.className="test-result "+(e.match?"passed":"failed"),n.innerHTML=`\n      <div class="test-header">\n        <span class="test-id">Sample ${e.id}</span>\n        <span class="test-status">${e.status}</span>\n        ${e.time?`<span class="test-time">${e.time.toFixed(2)}Seconds</span>`:""}\n      </div>\n      ${e.match?"":`\n        <div class="test-diff">\n          <div class="test-output">\n            <strong>Output:</strong><pre>${a(e.output)}</pre>\n          </div>\n          <div class="test-expected">\n            <strong>Expected:</strong><pre>${a(e.expected)}</pre>\n          </div>\n        </div>`}`,t.appendChild(n)}function a(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}async function d(e,t,n){let o={language:t.language,version:t.version,files:[{name:t.filename,content:e}],stdin:n,compile_timeout:1e4,run_timeout:3e3,compile_memory_limit:-1,run_memory_limit:-1},r=await fetch("https://emkc.org/api/v2/piston/execute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!r.ok)throw Error(`HTTP ${r.status}`);let i=await r.json(),a="",d="",s=0;return i.compile&&i.compile.output?(a=i.compile.output,d="Compilation Error"):i.run?(a=(i.run.stdout||"")+(i.run.stderr?"\n"+i.run.stderr:""),s=i.run.time||0,d=i.run.stderr.trim()?"Runtime Error":"Accepted"):(d="Execution Error",a="No Output"),{output:a,status:d,time:s}}function s(){let e=t.getValue().trim();if(!e)return void alert("❌ Code cannot be empty");let o=document.querySelector('meta[name="csrf-token"]')?.content||"",r=document.createElement("form");r.method="POST",r.action=`/problems/${n}/submit`,r.style.display="none";let i={utf8:"✓",authenticity_token:o,"submission[language_id]":11,"submission[source]":e,commit:"提交"};for(let e in i){let t=document.createElement("input");t.type="hidden",t.name=e,t.value=i[e],r.appendChild(t)}document.body.appendChild(r),r.submit()}GM_addStyle('\n  :root[data-theme="dark"] .highlight,\n  :root[data-theme="dark"] .highlight pre {\n    background: var(--bg2) !important;\n    color:      var(--fg0) !important;\n    border-radius: 6px;\n    border: 1px solid #444;\n  }\n\n  :root[data-theme="dark"] .highlight .nc,\n  :root[data-theme="dark"] .highlight .nx,\n  :root[data-theme="dark"] .highlight .nl {\n    color: #a9d;\n  }\n  :极简版[data-theme="dark"] .highlight .m  { color: #d19a66; }\n  :极简版[data-theme="dark"] .highlight .k  { color: #c678dd; }:root[data-theme="dark"] pre, :root[data-theme="dark"] code,:root[data-theme="dark"] pre code {background: var(--bg2) !important;color: var(--fg0) !important;  border: 1px solid #444 !important; border-radius: 6px !important;padding: 10px;display: block;overflow-x: auto;}  :root[data-theme="light"]{\n      --bg0:#ffffff;--bg1:#f8f9fa;--bg2:#e9ecef;--fg0:#222;--fg1:#000;\n      --accent:#007acc;--green:#2ecc71;--red:#e74c3c;--yellow:#d19a66;\n    }\n    :root[data-theme="dark"]{\n      --bg0:#1e1e1e;--bg1:#252526;--bg2:#2d2d2d;--fg0:#d4d4d4;--fg1:#e0e0e0;\n      --accent:#0a84ff;--green:#2ecc71;--red:#e06c75;--yellow:#d19a66;\n    }\n    html,body{height:100%;margin:0;padding:0;background:var(--bg0);color:var(--fg0);overflow:hidden;}\n    #nzoi-layout{display:flex;height:100vh;font-family:\'Segoe UI\',Tahoma,Geneva,Verdana,sans-serif;overflow:hidden;}\n    #main-container{width:62%;overflow-y:auto;padding:20px;box-sizing:border-box;background:var(--bg0);border-right:1px solid #333;}\n    #nzoi-resizer{width:6px;cursor:col-resize;background:#333;flex-shrink:0;}\n    #nzoi-resizer:hover,#nzoi-resizer:active{background:var(--accent);}\n    #nzoi-sidebar{width:38%;background:var(--bg0);color:var(--fg0);overflow:hidden;flex-shrink:0;}\n    .sidebar-content{height:100%;display:flex;flex-direction:column;overflow:hidden;padding:20px;}\n    .editor-controls{display:flex;justify-content:center;margin-bottom:12px;flex-wrap:wrap;}\n    .button-bar {\n      display: flex;\n      border-radius: 6px;\n      overflow: hidden;\n      border: 1px solid #444;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n    }\n\n    #run-btn, #submit-btn {\n      height: 30px;\n      padding: 0 20px;\n      font-weight: bold;\n      border: none;\n      transition: all 0.2s ease;\n    }\n\n    #run-btn {\n      background: #4263eb;\n      color: #fff;\n    }\n\n    #run-btn:hover {\n      background: #364fc7;\n    }\n\n    #submit-btn {\n      background: var(--green);\n      color: #fff;\n    }\n\n    #submit-btn:hover {\n      background: #27ae60;\n    }\n    #editor-container{height:50%;position:relative;}\n    #monaco-editor{height:100%;border:1px solid #444;border-radius:6px;background:var(--bg1);}\n    #editor-resizer{height:8px;background:#333;cursor:row-resize;margin:5px 0;}\n    #editor-resizer:hover,#editor-resizer:active{background:var(--accent);}\n    #test-results-container{height:calc(50% - 8px);overflow:hidden;display:flex;flex-direction:column;}\n    #test-results{background:var(--bg1);border:1px solid #444;border-radius:6px;padding:15px;flex-grow:1;overflow-y:auto;}\n    #test-results h3{margin:0 0 10px 0;font-size:16px;color:var(--fg1);}\n    #results-summary{padding:8px 12px;border-radius:6px;margin-bottom:12px;font-weight:700;}\n    #results-summary .passed{background:#264f36;color:var(--green);}\n    #results-summary .failed{background:#5a1d1d;color:var(--red);}\n    .test-result{border:1px solid #444;border-radius:6px;padding:12px;margin-bottom:10px;}\n    .test-result.passed{background:#1e2e24;}\n    .test-result.failed{background:#2e1e1e;}\n    .test-header{display:flex;gap:12px;align-items:center;margin-bottom:8px;flex-wrap:wrap;color:var(--fg1);}\n    .test-status{padding:2px 8px;border-radius:4px;font-size:13px;}\n    .test-result.passed .test-status{background:var(--green);color:#fff;}\n    .test-result.failed .极简版-status{background:var(--red);color:#fff;}\n    .test-time{font-size:13px;color:var(--yellow);}\n    .test-diff{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:10px;}\n    .test-output,.test-expected{background:var(--bg2);border:1px solid #444;border-radius:6px;padding:10px;}\n    .test-output pre,.test-expected pre{margin:8px 0 0;height:auto;max-height:150px;overflow:auto;background:var(--bg1);color:var(--fg0);white-space:pre-wrap;}\n    ::-webkit-scrollbar{width:10px;height:10px;}::-webkit-scrollbar-track{background:var(--bg2);}::-webkit-scrollbar-thumb{background:#555;border-radius:6px;}::-webkit-scrollbar-thumb:hover{background:#777;}\n  '),function(){var i,a,d;let l=document.getElementById("main-container");if(!l)return console.warn("Main content not found");let u=document.createElement("div");u.id="nzoi-layout";let c=document.createElement("div");c.id="nzoi-sidebar";let m,p,g=document.createElement("div");g.id="nzoi-resizer",l.parentNode.appendChild(u),u.appendChild(l),u.appendChild(g),u.appendChild(c),function(o){o.innerHTML='\n      <div class="sidebar-content">\n        <div class="editor-controls">\n          <div class="button-bar">\n            <button id="run-btn">Run</button>\n            <button id="submit-btn" title="Submit to judge">Submit</button>\n          </div>\n        </div>\n        <div id="editor-container"><div id="monaco-editor"></div></div>\n        <div id="editor-resizer"></div>\n        <div id="test-results-container">\n          <div id="test-results">\n            <h3>Sample test results</h3>\n            <div id="results-summary"></div>\n            <div id="results-details"></div>\n          </div>\n        </div>\n      </div>';let i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js",document.head.appendChild(i),i.onload=()=>{require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs"}}),require(["vs/editor/editor.main"],(()=>{let o="cpp",i=localStorage.getItem(`nzoi-code-${n}`)||function(e){return{cpp:"#include <bits/stdc++.h>\nusing namespace std;\n\nint main() {\n    // Your code here\n    return 0;\n}"}[e]||""}(o);t=monaco.editor.create(document.getElementById("monaco-editor"),{value:i,language:o,theme:"dark"===e?"vs-dark":"vs",automaticLayout:!0,minimap:{enabled:!1},fontSize:13,fontFamily:'Consolas, "Courier New", monospace',autoIndent:"full",formatOnPaste:!0,formatOnType:!0,suggestSelection:"first",acceptSuggestionOnEnter:"on",acceptSuggestionOnCommitCharacter:!0,tabCompletion:"on",wordBasedSuggestions:!0,scrollBeyondLastLine:!1}),t&&function(e){let t=new WebSocket("ws://localhost:3000"),n=1,o=new Map,r="file:///home/user/main.cpp",i=e.getModel();function a(e){if(!t||1!==t.readyState)return;let o=n++;e.id||(e.id=o),t.send(JSON.stringify({jsonrpc:"2.0",...e}))}monaco.languages.registerHoverProvider("cpp",{provideHover:(e,t)=>new Promise((e=>{let i=n++;o.set(i,(t=>{if(!t?.contents)return e(null);let n=Array.isArray(t.contents)?t.contents.map((e=>({value:e.value||e}))).filter(Boolean):[{value:t.contents.value||t.contents}];e({contents:n})})),a({method:"textDocument/hover",params:{textDocument:{uri:r},position:{line:t.lineNumber-1,character:t.column-1}},id:i})}))}),monaco.languages.registerCompletionItemProvider("cpp",{triggerCharacters:[".",">",":",'"',"/","*"],provideCompletionItems:(e,t)=>new Promise((e=>{let i=n++;o.set(i,(t=>{if(!t?.items)return e({suggestions:[]});let n=t.items.map((e=>({label:e.label,kind:monaco.languages.CompletionItemKind.Function,insertText:e.insertText||e.label})));e({suggestions:n})})),a({method:"textDocument/completion",params:{textDocument:{uri:r},position:{line:t.lineNumber-1,character:t.column-1}},id:i})}))}),t.addEventListener("open",(()=>{a({method:"initialize",params:{processId:null,rootUri:null,capabilities:{}}}),a({method:"textDocument/didOpen",params:{textDocument:{uri:r,languageId:"cpp",version:1,text:i.getValue()}}}),i.onDidChangeContent((()=>{a({method:"textDocument/didChange",params:{textDocument:{uri:r,version:n++},contentChanges:[{text:i.getValue()}]}})}))})),t.addEventListener("message",(e=>{let t=JSON.parse(e.data);if("textDocument/publishDiagnostics"===t.method){let e=t.params.diagnostics.map((e=>({severity:function(e){switch(e){case 1:return monaco.MarkerSeverity.Error;case 2:return monaco.MarkerSeverity.Warning;case 3:default:return monaco.MarkerSeverity.Info;case 4:return monaco.MarkerSeverity.Hint}}(e.severity),message:e.message,startLineNumber:e.range.start.line+1,startColumn:e.range.start.character+1,endLineNumber:e.range.end.line+1,endColumn:e.range.end.character+1})));monaco.editor.setModelMarkers(i,"clangd",e)}if(t.id&&o.has(t.id)){let e=o.get(t.id);o.delete(t.id),e(t.result)}}))}(t),t.addCommand(monaco.KeyCode.Tab,(()=>t.trigger("keyboard","acceptSelectedSuggestion",{})),"suggestWidgetVisible"),t.addCommand(monaco.KeyCode.Tab,(()=>t.trigger("keyboard","tab",{})),"!suggestWidgetVisible");let a=document.getElementById("editor-resizer"),d=document.getElementById("editor-container"),l=document.getElementById("test-results-container");a.addEventListener("mousedown",(e=>{function n(e){let n=document.querySelector(".sidebar-content").clientHeight,o=e.clientY-d.getBoundingClientRect().top;o>100&&n-o-a.offsetHeight>100&&(d.style.height=`${o}px`,l.style.height=`calc(100% - ${o+a.offsetHeight+60}px`,t.layout())}e.preventDefault(),document.addEventListener("mousemove",n),document.addEventListener("mouseup",(function e(){document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",e)}))})),d.style.height="50%",l.style.height="calc(50% - 8px)",t.layout(),t.getModel().onDidChangeContent((()=>localStorage.setItem(`nzoi-code-${n}`,t.getValue()))),document.getElementById("run-btn").onclick=()=>r(t),document.getElementById("submit-btn").onclick=s,window.nzoiEditor=t}))}}(c),a=l,d=c,m=0,p=0,(i=g).onmousedown=e=>{m=e.clientX,p=a.getBoundingClientRect().width,document.documentElement.style.cursor="col-resize",document.documentElement.style.userSelect="none",document.onmousemove=e=>{let t=e.clientX-m,n=p+t;n<300&&(n=300),n>window.innerWidth-350&&(n=window.innerWidth-350),a.style.width=n+"px",d.style.width=window.innerWidth-n-i.offsetWidth+"px",window.nzoiEditor&&window.nzoiEditor.layout()},document.onmouseup=()=>{document.onmousemove=null,document.documentElement.style.cursor="",document.documentElement.style.userSelect=""}},document.querySelectorAll("ul.samples li").forEach(((e,t)=>{let n=e.querySelector(".input pre"),r=e.querySelector(".output pre");n&&r&&o.push({id:t+1,input:n.textContent,output:r.textContent})}))}()}();
